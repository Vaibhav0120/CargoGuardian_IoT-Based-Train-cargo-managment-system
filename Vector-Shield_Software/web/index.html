<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Vector Shield - Train Monitoring System">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Vector Shield">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>Vector Shield</title>
  <link rel="manifest" href="manifest.json">

  <!-- Define JavaScript functions BEFORE they are used -->
  <script>
    // The value below is injected by flutter build, do not touch.
    var serviceWorkerVersion = null;
    
    // Global variables
    window.hasLocationPermission = false;
    window.googleMapsLoaded = false;
    window.mapInstances = {};
    
    // Google Maps callback - Define this BEFORE loading the Google Maps API
    window.initGoogleMapsCallback = function() {
      console.log("Google Maps API loaded successfully");
      window.googleMapsLoaded = true;
    };
    
    // Function to get location permission status
    window.getLocationPermission = function() {
      return window.hasLocationPermission || false;
    };
    
    // Function to request location permission
    window.requestLocationPermission = function() {
      if (navigator.geolocation) {
        try {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              console.log("Location permission granted");
              window.hasLocationPermission = true;
            },
            function(error) {
              console.log("Location permission denied or error:", error.message);
              window.hasLocationPermission = false;
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } catch (e) {
          console.error("Error requesting location permission:", e);
          window.hasLocationPermission = false;
        }
      }
    };
    
    // Function to initialize a map
    window.initializeMap = function(elementId, lat, lng, title) {
      if (!window.googleMapsLoaded) {
        console.log("Google Maps not loaded yet, will try again later");
        setTimeout(function() {
          window.initializeMap(elementId, lat, lng, title);
        }, 1000);
        return;
      }
      
      try {
        console.log("Initializing map with ID:", elementId);
        
        // Find the map container by ID
        const mapContainer = document.getElementById(elementId);
        if (!mapContainer) {
          console.error("Map container not found with ID:", elementId);
          return;
        }
        
        // Create a map instance
        const map = new google.maps.Map(mapContainer, {
          center: { lat: lat, lng: lng },
          zoom: 14,
          mapTypeControl: true,
          fullscreenControl: true,
          streetViewControl: true,
          zoomControl: true
        });
        
        // Add a marker
        const marker = new google.maps.Marker({
          position: { lat: lat, lng: lng },
          map: map,
          title: title
        });
        
        // Store map instance for later reference
        window.mapInstances[elementId] = {
          map: map,
          marker: marker
        };
        
        console.log("Map initialized successfully");
      } catch (e) {
        console.error("Error initializing map:", e);
      }
    };

    // Function to open a URL in a new tab - FIXED to avoid recursion
    window.openExternal = function(url) {
      if (url && typeof url === 'string') {
        window.open(url, '_blank');
      }
    };
  </script>

  <!-- Add Google Maps API with callback - AFTER defining the callback function -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDS3Qwxu0gTG5i0inF8V2-jdeFFhch9PSQ&callback=initGoogleMapsCallback" async></script>
  
  <!-- Improved script loading with error handling -->
  <script src="flutter.js" defer></script>
</head>
<body>
  <div id="loading">
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f0f7ff;
        font-family: Arial, sans-serif;
      }
      #loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(66, 133, 244, 0.2);
        border-top-color: #4285f4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to {transform: rotate(360deg);}
      }
      .loading-text {
        color: #4285f4;
        font-size: 18px;
        font-weight: 500;
      }
      .error-container {
        display: none;
        text-align: center;
        padding: 20px;
        max-width: 80%;
      }
      .error-title {
        color: #d32f2f;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .error-message {
        color: #555;
        margin-bottom: 20px;
      }
      .retry-button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .retry-button:hover {
        background-color: #3367d6;
      }
    </style>
    <div class="spinner"></div>
    <div class="loading-text">Loading Vector Shield...</div>
    <div id="error-container" class="error-container">
      <div class="error-title">Initialization Error</div>
      <div id="error-message" class="error-message">An error occurred while loading the application.</div>
      <button id="retry-button" class="retry-button">Try Again</button>
    </div>
  </div>

  <script>
    // Request location permission after page loads
    window.addEventListener('load', function() {
      // Safe call to requestLocationPermission
      if (typeof window.requestLocationPermission === 'function') {
        setTimeout(window.requestLocationPermission, 2000);
      } else {
        console.error("requestLocationPermission function not defined");
      }
    });
    
    // Improved Flutter initialization with error handling
    window.addEventListener('load', function() {
      var loading = document.querySelector('#loading');
      var errorContainer = document.querySelector('#error-container');
      var errorMessage = document.querySelector('#error-message');
      var retryButton = document.querySelector('#retry-button');
      
      function showError(message) {
        if (loading) {
          var spinner = loading.querySelector('.spinner');
          var loadingText = loading.querySelector('.loading-text');
          if (spinner) spinner.style.display = 'none';
          if (loadingText) loadingText.style.display = 'none';
        }
        if (errorMessage) errorMessage.textContent = message || 'Failed to initialize the application.';
        if (errorContainer) errorContainer.style.display = 'block';
      }
      
      if (retryButton) {
        retryButton.addEventListener('click', function() {
          window.location.reload();
        });
      }

      // Initialize Flutter with better error handling
      _flutter.loader.loadEntrypoint({
        serviceWorker: {
          serviceWorkerVersion: serviceWorkerVersion,
        },
        onEntrypointLoaded: async function(engineInitializer) {
          try {
            const appRunner = await engineInitializer.initializeEngine({
              // Use HTML renderer for better compatibility on Vercel
              renderer: 'html'
            });
            await appRunner.runApp();
            
            // Hide loading screen after app is loaded
            if (loading) {
              // Fade out loading screen
              loading.style.transition = 'opacity 0.5s ease';
              loading.style.opacity = '0';
              
              // Remove loading screen after fade out
              setTimeout(function() {
                if (loading && loading.parentNode) {
                  loading.parentNode.removeChild(loading);
                }
              }, 500);
            }
          } catch (e) {
            console.error('Flutter initialization error:', e);
            showError('Failed to initialize Flutter: ' + e.message);
          }
        }
      }).catch(function(err) {
        console.error('Flutter loader error:', err);
        showError('Failed to load application resources: ' + err.message);
      });
    });
  </script>
</body>
</html>


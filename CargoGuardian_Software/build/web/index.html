<!-- Replace your entire index.html with this version -->
<!DOCTYPE html>
<html>
<head>
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="CargoGuardian - Train Monitoring System">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="CargoGuardian">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- Mobile viewport optimization -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>CargoGuardian</title>
  <link rel="manifest" href="manifest.json">

  <!-- Define JavaScript functions BEFORE they are used -->
  <script>
    // The value below is injected by flutter build, do not touch.
    const serviceWorkerVersion = "4032404379";
    
    // Global variables
    window.hasLocationPermission = false;
    window.googleMapsLoaded = false;
    window.mapInstances = {};
    window.isMobileBrowser = false;
    window.isIOSSafari = false;
    
    // Detect mobile browser and iOS Safari specifically
    (function() {
      try {
        var userAgent = navigator.userAgent.toLowerCase();
        window.isMobileBrowser = /mobile|android|iphone|ipad/.test(userAgent);
        window.isIOSSafari = /iphone|ipad|ipod/.test(userAgent) && /safari/.test(userAgent);
        console.log("Running on " + (window.isMobileBrowser ? "mobile" : "desktop") + " browser");
        if (window.isIOSSafari) {
          console.log("Detected iOS Safari browser");
          // Add iOS Safari specific class to body
          document.documentElement.classList.add('ios-safari');
        }
      } catch (e) {
        console.error("Error detecting browser type:", e);
      }
    })();
    
    // Google Maps callback - Define this BEFORE loading the Google Maps API
    window.initGoogleMapsCallback = function() {
      console.log("Google Maps API loaded successfully");
      window.googleMapsLoaded = true;
    };
    
    // Function to get location permission status - iOS safe version
    window.getLocationPermission = function() {
      return window.hasLocationPermission || false;
    };
    
    // Function to request location permission - iOS safe version
    window.requestLocationPermission = function() {
      if (navigator.geolocation) {
        try {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              console.log("Location permission granted");
              window.hasLocationPermission = true;
            },
            function(error) {
              console.log("Location permission denied or error:", error.message);
              window.hasLocationPermission = false;
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        } catch (e) {
          console.error("Error requesting location permission:", e);
          window.hasLocationPermission = false;
        }
      }
    };
    
    // Function to initialize a map - iOS safe version
    window.initializeMap = function(elementId, lat, lng, title) {
      if (!window.googleMapsLoaded) {
        console.log("Google Maps not loaded yet, will try again later");
        setTimeout(function() {
          window.initializeMap(elementId, lat, lng, title);
        }, 1000);
        return;
      }
      
      try {
        console.log("Initializing map with ID:", elementId);
        
        // Find the map container by ID
        const mapContainer = document.getElementById(elementId);
        if (!mapContainer) {
          console.error("Map container not found with ID:", elementId);
          return;
        }
        
        // Create a map instance
        const map = new google.maps.Map(mapContainer, {
          center: { lat: lat, lng: lng },
          zoom: 14,
          mapTypeControl: true,
          fullscreenControl: true,
          streetViewControl: true,
          zoomControl: true
        });
        
        // Add a marker
        const marker = new google.maps.Marker({
          position: { lat: lat, lng: lng },
          map: map,
          title: title
        });
        
        // Store map instance for later reference
        window.mapInstances[elementId] = {
          map: map,
          marker: marker
        };
        
        console.log("Map initialized successfully");
      } catch (e) {
        console.error("Error initializing map:", e);
      }
    };

    // Function to open a URL in a new tab - iOS safe version
    window.openExternalUrl = function(url) {
      console.log("openExternalUrl called with URL:", url);
      if (url && typeof url === 'string') {
        try {
          // For iOS Safari, we need to handle this differently
          if (window.isIOSSafari) {
            window.location.href = url;
          } else {
            // Use window.open for other browsers
            const newWindow = window.open(url, '_blank');
            // Focus the new window if possible
            if (newWindow) {
              newWindow.focus();
            }
          }
        } catch (e) {
          console.error("Error opening URL:", e);
          // Fallback method
          window.location.href = url;
        }
      }
    };
  </script>

  <!-- Add Google Maps API with callback - AFTER defining the callback function -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDS3Qwxu0gTG5i0inF8V2-jdeFFhch9PSQ&callback=initGoogleMapsCallback&loading=async"></script>
  
  <style>
    /* iOS Safari specific styles */
    .ios-safari .flutter-loader {
      animation-duration: 1.5s !important; /* Slower animation for iOS */
    }
  </style>
</head>
<body>
  <div id="loading">
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #f0f7ff;
        font-family: Arial, sans-serif;
        overflow: hidden; /* Prevent scrolling during loading */
      }
      #loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 9999;
        background-color: #f0f7ff;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(66, 133, 244, 0.2);
        border-top-color: #4285f4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        to {transform: rotate(360deg);}
      }
      .loading-text {
        color: #4285f4;
        font-size: 18px;
        font-weight: 500;
      }
      .error-container {
        display: none;
        text-align: center;
        padding: 20px;
        max-width: 80%;
      }
      .error-title {
        color: #d32f2f;
        font-size: 20px;
        margin-bottom: 10px;
      }
      .error-message {
        color: #555;
        margin-bottom: 20px;
      }
      .retry-button {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      .retry-button:hover {
        background-color: #3367d6;
      }
    </style>
    <div class="spinner"></div>
    <div class="loading-text">Loading CargoGuardian...</div>
    <div id="error-container" class="error-container">
      <div class="error-title">Initialization Error</div>
      <div id="error-message" class="error-message">An error occurred while loading the application.</div>
      <button id="retry-button" class="retry-button">Try Again</button>
    </div>
  </div>

  <script>
    // Function to show error message
    function showError(message) {
      var loading = document.getElementById('loading');
      var errorContainer = document.getElementById('error-container');
      var errorMessage = document.getElementById('error-message');
      var spinner = document.querySelector('.spinner');
      var loadingText = document.querySelector('.loading-text');
      
      if (spinner) spinner.style.display = 'none';
      if (loadingText) loadingText.style.display = 'none';
      if (errorMessage) errorMessage.textContent = message || 'Failed to initialize the application.';
      if (errorContainer) errorContainer.style.display = 'block';
    }
    
    // Request location permission after page loads
    window.addEventListener('load', function() {
      // Safe call to requestLocationPermission
      if (typeof window.requestLocationPermission === 'function') {
        setTimeout(window.requestLocationPermission, 2000);
      } else {
        console.error("requestLocationPermission function not defined");
      }
      
      // Set up retry button
      var retryButton = document.getElementById('retry-button');
      if (retryButton) {
        retryButton.addEventListener('click', function() {
          window.location.reload();
        });
      }
    });
    
    // Improved Flutter initialization with error handling and iOS detection
    window.addEventListener('load', function() {
      var loading = document.getElementById('loading');
      
      // Load flutter.js with proper error handling
      var scriptTag = document.createElement('script');
      scriptTag.src = 'flutter.js';
      scriptTag.type = 'application/javascript';
      
      scriptTag.onload = function() {
        console.log("flutter.js loaded successfully");
        initFlutterApp();
      };
      
      scriptTag.onerror = function() {
        console.error("Failed to load flutter.js");
        showError("Failed to load application resources. Please check your internet connection and try again.");
      };
      
      document.body.appendChild(scriptTag);
      
      // Initialize Flutter app with iOS-specific handling
      function initFlutterApp() {
        if (typeof _flutter === 'undefined') {
          console.log("Waiting for flutter.js to load...");
          setTimeout(initFlutterApp, 100);
          return;
        }
        
        // Add extra delay for iOS Safari
        var initDelay = window.isIOSSafari ? 2000 : (window.isMobileBrowser ? 1000 : 0);
        console.log("Using initialization delay of " + initDelay + "ms");
        
        setTimeout(function() {
          try {
            // Initialize Flutter with better error handling
            _flutter.loader.loadEntrypoint({
              serviceWorker: {
                serviceWorkerVersion: serviceWorkerVersion,
              },
              onEntrypointLoaded: async function(engineInitializer) {
                try {
                  console.log("Flutter entrypoint loaded, initializing engine...");
                  
                  // Always use html renderer for iOS Safari, canvaskit for desktop
                  const renderer = window.isIOSSafari ? "html" : (window.isMobileBrowser ? "html" : "canvaskit");
                  console.log("Using renderer:", renderer);
                  
                  const appRunner = await engineInitializer.initializeEngine({
                    renderer: renderer,
                    useColorEmoji: true
                  });
                  
                  console.log("Flutter engine initialized, running app...");
                  await appRunner.runApp();
                  
                  // Hide loading screen after app is loaded
                  if (loading) {
                    // Fade out loading screen
                    loading.style.transition = 'opacity 0.5s ease';
                    loading.style.opacity = '0';
                    
                    // Remove loading screen after fade out
                    setTimeout(function() {
                      if (loading && loading.parentNode) {
                        loading.parentNode.removeChild(loading);
                      }
                    }, 500);
                  }
                } catch (e) {
                  console.error('Flutter initialization error:', e);
                  showError('Failed to initialize Flutter: ' + e.message);
                }
              }
            }).catch(function(err) {
              console.error('Flutter loader error:', err);
              showError('Failed to load application resources: ' + err.message);
            });
          } catch (e) {
            console.error("Error during Flutter initialization:", e);
            showError("Failed to initialize the application: " + e.message);
          }
        }, initDelay);
      }
    });
  </script>
</body>
</html>